---
---

Pkl (pronounced Pickle) is a new programming language from Apple designed specifically for configuration. It allows developers to design data models richly and expressively through the use of types and then validate them to catch errors early on.

A feature that sets it apart for Apple developers and, as it couldn't be any other way with Pkl being an Apple language, is that it has a suite of tools available for generating Swift interfaces from `.pkl` configuration files. 

In this article, you will learn how to install and use the `pkl-gen-swift` command-line tool and how to integrate it into your Swift Package Manager (SPM) project as a plugin.

Something you must note is that, at this point, Pkl is only available for macOS.

## An example Pkl config

Let's get started by creating a simple Pkl module called `Config` with a set of properties that will define the configuration of a small macOS Swift Package library:

```pkl:Config.pkl
module Config

baseUrl: String
retryCount: Int(isBetween(0, 3))
timeout: Duration
```

As you can see in the snippet above, we are making use of types and ranges to constraint the values that can be assigned to the properties and reduce the likelihood of errors. These types will be used by the Pkl CLI tools to both validate the configuration files and help generate Swift interfaces.

Let's now write a separate `.pkl` file that amends this module file and provides values for the development configuration:

```pkl:local.pkl
amends "Config.pkl"

baseUrl = "https://localhost:8080"
retryCount = 0
timeout = 30.s
```

And just like that, we have written a small configuration and we have specified some types and constraints that we can enforce.

Let's now install the `pkl` command line tool and evaluate the module that defines the actual values:

```bash:Terminal
# Install pkl
curl -L -o pkl https://github.com/apple/pkl/releases/download/0.25.2/pkl-macos-aarch64
chmod +x pkl

# Evaluate the local file
./pkl eval Sources/ClientExample/Resources/local.pkl
```

The output of running the commands above prints the correct values and validates that the configurations can be validated accordingly:

```bash:Terminal
baseUrl = "https://localhost:8080"
retryCount = 0
timeout = 30.s
```

## Generating Swift bindings

As I mentioned at the beginning of the article, one of the most powerful features of defining your configuration using Pkl is that you can generate Swift interfaces for your apps.

To generate Swift interfaces from `pkl` files, you need to install the `pkl` and `pkl-gen-swift` command-line tools. I will now show you how you can install and use them both manually and in a Swift Package Manager plugin.

### Installing and using `pkl-gen-swift` manually

First, let's install the `pkl-gen-swift` command-line tool:

```bash:Terminal
curl -L https://github.com/apple/pkl-swift/releases/download/0.2.3/pkl-gen-swift-macos.bin -o pkl-gen-swift
chmod +x pkl-gen-swift
```

Let's now generate Swift interfaces from the `.pkl` files by running the following command with all input files as arguments and the output directory passed to the `-o` flag:

```bash:Terminal
PKL_EXEC=./pkl
./pkl-gen-swift Sources/ClientExample/Resources/*.pkl -o Sources/ClientExample/Generated
```

Note that `pkl-gen-swift` relies on the `pkl` command-line tool, which needs to either be found in your `PATH` or be specified using the `PKL_EXEC` environment variable.

The output of the command will be a single Swift file that contains the generated interface:

```swift:Sources/ClientExample/Generated/Config.pkl.swift
// Code generated from Pkl module `Config`. DO NOT EDIT.
import PklSwift

public enum Config {}

extension Config {
    public struct Module: PklRegisteredType, Decodable, Hashable {
        public static var registeredIdentifier: String = "Config"

        public var baseUrl: String

        public var retryCount: Int

        public var timeout: Duration

        public init(baseUrl: String, retryCount: Int, timeout: Duration) {
            self.baseUrl = baseUrl
            self.retryCount = retryCount
            self.timeout = timeout
        }
    }

    /// Load the Pkl module at the given source and evaluate it into `Config.Module`.
    ///
    /// - Parameter source: The source of the Pkl module.
    public static func loadFrom(source: ModuleSource) async throws -> Config.Module {
        try await PklSwift.withEvaluator { evaluator in
            try await loadFrom(evaluator: evaluator, source: source)
        }
    }

    /// Load the Pkl module at the given source and evaluate it with the given evaluator into
    /// `Config.Module`.
    ///
    /// - Parameter evaluator: The evaluator to use for evaluation.
    /// - Parameter source: The module to evaluate.
    public static func loadFrom(
        evaluator: PklSwift.Evaluator,
        source: PklSwift.ModuleSource
    ) async throws -> Config.Module {
        try await evaluator.evaluateModule(source: source, as: Module.self)
    }
}
```

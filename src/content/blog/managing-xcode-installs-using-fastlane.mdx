---
title: 'Managing multiple Xcode installs on CI using Fastlane'
excerpt: ''
pubDate: 2023-03-01
---

import StaticTweet from '@components/static-tweet/StaticTweet.astro'

The [2.211.0 release of Fastlane](https://github.com/fastlane/fastlane/releases/tag/2.211.0) introduces a new action to manage Xcode versions directly from fastlane. As well as introducing a new lane, this release also deprecates the existing [xcode-install](http://docs.fastlane.tools/actions/xcode_install) and [xcversion](https://docs.fastlane.tools/actions/xcversion) actions.

<StaticTweet id="1591561723794030592" />

This post will explore the current state of Xcode version management on CI using Fastlane.

## Setting a version

Setting an Xcode version at the beginning of Fastlane's execution can be a very useful way of making your actions as portable and reusable as possible for you and your team.

Since Fastlane usually runs in a CI environment, you want to make sure that selecting an Xcode version does not meddle with the system's settings and does not require any manual intervention, such as asking for sudo permissions.

Both `xcode_select` and `xcodes` are able to achieve this by setting the `DEVELOPER_DIR` environment variable to the path of the selected Xcode application's contents. Contrary to what running `xcode-select -s` does, setting the `DEVELOPER_DIR` environment variable does not require root permissions and only affects the current shell session.

### Using `xcode_select`

The `xcode_select` action is the simplest and less invasive way of selecting an Xcode version to use. The action requires is the full path to an Xcode application (e.g. `/Applications/Xcode_14.3.app`) and the only thing it does is set the `DEVELOPER_DIR` environment variable to the path provided.

Setting the `DEVELOPER_DIR` environment variable only selects a version of Xcode for a given Fastlane execution and does not change the system's selection.

```ruby:fastlane/Fastfile
# Set the version before every lane...
before_all do
    xcode_select("/Applications/Xcode-14.1.app")
end
```

A big downside of this approach is that, since it requires a full path to the Xcode application, it requires a strict naming convention for all Xcode installations across all runners.

### Using `xcodes`

The alternative to using `xcode_select` now that both `xcode-install` and `xcversion` are depecrated is the `xcodes` action. This action is a wrapper around the [xcodes CLI](https://github.com/RobotsAndPencils/xcodes), an application I have used for a very long time to manage Xcode versions on my machine.

The downside to this new lane is that it no longer works out-of-the-box as it relies on the system having [xcodes](https://github.com/RobotsAndPencils/xcodes) installed.

## Installing `xcodes`

The `xcodes` command line tool is available on Homebrew, and can be installed it by running:

```bash:Terminal
brew install robotsandpencils/made/xcodes
```

### Selecting an available version

Similarily to the way `xcode-select` works, `xcodes` can be used to select a version of Xcode which is already installed in the system.

The `xcodes` action uses a version parameter instead of a path and finds the correct Xcode application in the system.

By default, the action will install the queried version of Xcode if it can't be found in the system and select it system-wide. This behaviour can be disabled by setting the `select_for_current_build_only` parameter to `true`, which I would thoroughly recommend:

```ruby:fastlane/Fastfile
before_all do
    xcodes(version: "14.1", select_for_current_build_only: true)
end
```

> Note that the `xcodes` action expects a valid [RubyGems style requirements](https://guides.rubygems.org/releasing-rubygems) for the version parameter. For example, you would select a stable version of Xcode by passing `14.1`, and a pre-release version by passing `14.1.beta.3`.

### Creating an `.xcode-version` file

The `xcodes` action can also be used to select a version of Xcode based on the contents of a `.xcode-version` file. This is a very common pattern in other version managers such as [rbenv](https://github.com/rbenv/rbenv), [nvm](https://github.com/nvm-sh/nvm) and [swiftenv](https://github.com/kylef/swiftenv).

Let's consider the following `.xcode-version` file:

```text:.xcode-version
14.1
```

You can then modify the code in the previous section to use the `.xcode-version` file instead of a hardcoded version:

```ruby:fastlane/Fastfile
before_all do
    xcodes(select_for_current_build_only: true)
end
```

### Install if needed

Now that we've seen how you can select a version of Xcode that is already installed in the system, let's see how you can install a version of Xcode that is not already installed.

> Note that running the action without `select_for_current_build_only` requires authentication with Apple's Developer Portal as well as `sudo` permissions to change the selected Xcode version system-wide.

To make the `xcodes` action install a version of Xcode if it is not already installed, simply do not pass the `select_for_current_build_only` parameter.

You must be careful that this has a potentially undesirable side-effect: the action will select the newly installed version of Xcode system-wide, requiring sudo permissions.

```ruby:fastlane/Fastfile
lane :install_xcode do |values|
    # Specifying the version directly
    xcodes(version: values[:version])

    # Or using a .xcode-version file
    xcodes
end
```

The list of available Xcode versions is always updated before the new version is installed. If you don't want the list to be updated, you can pass set the `update_list` parameter to `false`:

```ruby:fastlane/Fastfile
lane :install_xcode do |values|
    # Specifying the version directly
    xcodes(version: values[:version], update_list: false)

    # Or using a .xcode-version file
    xcodes(update_list: false)
end
```

## Going the extra mile üèÉ‚Äç‚ôÇÔ∏è

If you'd like to get some extra security in place and make sure that the selected version of Xcode is the one you expect and valid, there are some extra steps you can follow.

### Ensuring the selected version of Xcode is correct

If you'd like to go the extra mile and add an extra check to verify that the correct version of Xcode is selected, you can do so by using the [ensure_xcode_version action](https://docs.fastlane.tools/actions/ensure_xcode_version).

The action requires a version string as a parameter and will fail the build if the selected version of Xcode does not match the version string.

```ruby:fastlane/Fastfile
before_all do
    # Select the version of Xcode for this build only
    xcodes(version: "14.1", select_for_current_build_only: true)

    # Make sure that the correct version of Xcode is selected
    ensure_xcode_version(version: "14.1")
end
```

It is also worth mentioning that, similarly to the way the `xcodes` action works, `ensure_xcode_version` also looks for a `.xcode-version` file in the root of the repository and will use the version specified in that file if no version is passed as a parameter.

```ruby:fastlane/Fastfile
before_all do
    # Select the version of Xcode for this build only
    # Uses `.xcode-version` file
    xcodes(select_for_current_build_only: true)

    # Make sure that the correct version of Xcode is selected
    # Uses `.xcode-version` file
    ensure_xcode_version
end
```

### Validate the newly installed version of Xcode

If you are going to install a new version of Xcode using the new [xcodes action](https://docs.fastlane.tools/actions/xcodes), there is also a built-in action you can use to ensure that the newly installed version of Xcode is properly signed by Apple: [verify_xcode](http://docs.fastlane.tools/actions/verify_xcode).

The action can be passed a path to the Xcode application to verify, or it will use the currently selected version of Xcode if no path is passed.

```ruby:fastlane/Fastfile
lane :install_xcode do |values|
    # Install and select an Xcode version
    xcodes(version: values[:version])

    # Verify the newly installed version of Xcode
    verify_xcode
end
```
